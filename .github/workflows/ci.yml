name: CI - Test Infrastructure

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-backend:
    name: ðŸ Backend (Pytest)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./projects/erp_ganadero/backend

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio pytest-cov httpx faker
        
    - name: Run Unit Tests
      run: |
        python -m pytest app/L2_foundation/test_crud_operations.py -v

  test-frontend:
    name: âš›ï¸ Frontend (Vitest)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./projects/erp_ganadero/frontend-v2

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: ./projects/erp_ganadero/frontend-v2/package-lock.json
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run Component Tests
      run: npx vitest run

  test-e2e:
    name: ðŸŽ­ E2E (TestSprite)
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js for TestSprite
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install TestSprite Dependencies
      working-directory: ./projects/erp_ganadero/testsprite
      run: |
        npm install
        npx playwright install --with-deps chromium
        
    - name: Install Backend (for local E2E env)
      working-directory: ./projects/erp_ganadero/backend
      run: |
        pip install -r requirements.txt
        # We need a way to run the backend in background
        nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 &
        
    - name: Install Frontend (for local E2E env)
      working-directory: ./projects/erp_ganadero/frontend-v2
      run: |
        npm ci
        echo "VITE_API_URL=http://localhost:8000" > .env
        nohup npm run dev -- --port 3001 &
        
    - name: Wait for servers
      run: sleep 15
      
    - name: Run TestSprite
      working-directory: ./projects/erp_ganadero/testsprite
      run: ./bin/testsprite.js
